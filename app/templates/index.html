<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能药箱管理系统</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f7f7f7;
            color: #333;
            margin: 0;
            padding: 0;
        }
        .container {
            display: flex;
            flex-direction: row;
            padding: 20px;
            min-height: 100vh;
        }
        .sidebar {
            width: 250px;
            padding: 20px;
            background-color: #e8f0fe;
            border-radius: 8px;
            margin-right: 20px;
        }
        .content {
            flex: 1;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .sidebar-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }
        .menu-group {
            margin-bottom: 20px;
        }
        .menu-title {
            font-size: 18px;
            margin-bottom: 10px;
            color: #666;
        }
        .menu-item {
            display: block;
            width: 100%;
            padding: 10px 15px;
            margin-bottom: 8px;
            background-color: #fff;
            color: #333;  /* 添加明确的文字颜色 */
            border: 1px solid #e1e1e1;  /* 添加边框增强可见性 */
            border-radius: 5px;
            cursor: pointer;
            text-align: left;
            font-weight: 500;  /* 稍微加粗文字 */
            transition: all 0.3s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);  /* 添加轻微阴影 */
        }
        .menu-item:hover {
            background-color: #d4e4fd;
            border-color: #a8c7fa;
        }
        .menu-item.active {
            background-color: #6c63ff;
            color: white;
            border-color: #5b54d6;
            box-shadow: 0 2px 4px rgba(108, 99, 255, 0.2);
        }
        .content-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .content-table th, .content-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .content-table th {
            background-color: #f5f5f5;
        }        .form-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        .btn-primary {
            background-color: #6c63ff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #5b54d6;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 1px solid #c3e6cb;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
        }
        .medicine-search {
            margin-bottom: 20px;
        }
        .medicine-item {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .medicine-info {
            flex: 1;
        }
        .medicine-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .quantity-input {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }        .warning-message {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 1px solid #ffeaa7;
        }
          /* 药品提醒样式 */
        .alerts-container {
            display: flex;
            gap: 20px;
        }
        
        .alert-section {
            flex: 1;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .alert-section h3 {
            margin-top: 0;
            border-bottom: 1px solid #e6e6e6;
            padding-bottom: 10px;
            color: #555;
        }
        
        .alerts-content {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .alert-items {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .alert-item {
            background-color: #ffffff;
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #6c63ff;
        }
        
        .alert-item.urgent-alert {
            border-left-color: #f44336;
            background-color: #fff8f8;
        }
        
        .alert-item.warning-alert {
            border-left-color: #ff9800;
            background-color: #fffbf4;
        }
        
        .alert-item.danger-alert {
            border-left-color: #dc3545;
            background-color: #f8f4f4;
        }
        
        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .alert-header h4 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }
        
        .expiry-days, .stock-count, .expired-days {
            font-weight: bold;
            font-size: 14px;
            padding: 3px 8px;
            border-radius: 15px;
            background-color: #e8f0fe;
            color: #4285f4;
        }
        
        .urgent-alert .expiry-days, .urgent-alert .stock-count, .urgent-alert .expired-days {
            background-color: #ffe7e7;
            color: #f44336;
        }
        
        .warning-alert .expiry-days, .warning-alert .stock-count, .warning-alert .expired-days {
            background-color: #fff3e0;
            color: #ff9800;
        }
        
        .danger-alert .expired-days {
            background-color: #ffe1e1;
            color: #dc3545;
        }
        
        .alert-details {
            margin-bottom: 12px;
        }
        
        .alert-details p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .alert-actions {
            display: flex;
            gap: 10px;
        }
        
        .empty-alert {
            padding: 20px;
            text-align: center;
            color: #666;
            font-style: italic;
            background-color: #f9f9f9;
            border-radius: 5px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h1 class="sidebar-title">智能药箱管理系统</h1>
            <div class="menu-group">
                <h2 class="menu-title">查询功能</h2>
                <button class="menu-item" id="query-members">家庭成员信息</button>
                <button class="menu-item" id="query-medicines">药品信息</button>
                <button class="menu-item" id="query-prescriptions">处方信息</button>
                <button class="menu-item" id="query-current-medications">当前用药情况</button>
            </div>            <div class="menu-group">
                <h2 class="menu-title">药品管理</h2>
                <button class="menu-item" id="add-new-medicine">添加新药</button>
                <button class="menu-item" id="refill-medicine">补充药品</button>
                <button class="menu-item" id="remove-medicine">删除药品</button>
            </div>
            <div class="menu-group">
                <h2 class="menu-title">提醒服务</h2>
                <button class="menu-item" id="medicine-alerts">药品提醒</button>
            </div>
        </div>
        <div class="content" id="content-area">
            <h2>欢迎使用智能药箱管理系统</h2>
            <p>请点击左侧菜单选择要查看的内容。</p>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // 初始化数据
            $.post('/api/init_data', function(response) {
                console.log('数据初始化完成');
            }).fail(function() {
                console.warn('数据初始化失败');
            });
            
            $('.menu-item').click(function() {
                $('.menu-item').removeClass('active');
                $(this).addClass('active');
            });

            $('#query-members').click(function() {
                $.get('/api/members', function(data) {
                    let content = '<div class="content-card"><h2>家庭成员信息</h2>';
                    if (data.length === 0) {
                        content += '<div class="empty-state"><p>暂无家庭成员信息</p></div>';
                    } else {
                        content += '<table class="content-table">';
                        content += '<tr><th>姓名</th><th>ID</th><th>性别</th><th>年龄</th><th>操作</th></tr>';
                        data.forEach(function(member) {
                            content += `<tr>
                                <td>${member.name}</td>
                                <td>${member.security_id}</td>
                                <td>${member.gender}</td>
                                <td>${member.age}</td>
                                <td>
                                    <button onclick="viewMemberDetails('${member.security_id}')" class="btn btn-primary">查看详情</button>
                                    <button onclick="editMemberInfo('${member.security_id}')" class="btn btn-secondary">编辑信息</button>
                                </td>
                            </tr>`;
                        });
                        content += '</table>';
                    }
                    content += '</div>';
                    $('#content-area').html(content);
                });
            });

            $('#query-medicines').click(function() {
                $.get('/api/medicines', function(data) {
                    let content = '<div class="content-card"><h2>药品信息</h2>';
                    if (data.length === 0) {
                        content += '<div class="empty-state"><p>暂无药品信息</p></div>';
                    } else {
                        content += '<table class="content-table">';
                        content += '<tr><th>药品名称</th><th>编码</th><th>剩余数量</th><th>药品类型</th><th>操作</th></tr>'; // 添加药品类型表头
                        data.forEach(function(medicine) {
                            content += `<tr>
                                <td>${medicine.name}</td>
                                <td>${medicine.national_code}</td>
                                <td>${medicine.remaining_quantity}</td>
                                <td>${medicine.medicine_type}</td> <!-- 显示药品类型 -->
                                <td><button onclick="viewMedicineDetails('${medicine.national_code}')">查看详情</button></td>
                            </tr>`;
                        });
                        content += '</table>';
                    }
                    content += '</div>';
                    $('#content-area').html(content);
                });
            });

            $('#query-prescriptions').click(function() {
                $.get('/api/prescriptions', function(data) {
                    let content = '<div class="content-card"><h2>处方信息</h2>';
                    if (data.length === 0) {
                        content += '<div class="empty-state"><p>暂无处方信息</p></div>';
                    } else {
                        content += '<table class="content-table">';
                        content += '<tr><th>处方ID</th><th>开具时间</th><th>医生</th><th>操作</th></tr>';
                        data.forEach(function(prescription) {
                            content += `<tr>
                                <td>${prescription.prescription_id}</td>
                                <td>${prescription.time}</td>
                                <td>${prescription.doctor}</td>
                                <td><button onclick="viewPrescriptionDetails('${prescription.prescription_id}')">查看详情</button></td>
                            </tr>`;
                        });
                        content += '</table>';
                    }
                    content += '</div>';
                    $('#content-area').html(content);
                });
            });

            $('#query-current-medications').click(function() {
                // 添加加载状态提示
                $('#content-area').html('<div class="content-card"><h2>用药情况</h2><p>加载中，请稍候...</p></div>');
                
                // 创建页面结构，包含切换按钮
                let content = '<div class="content-card"><h2>用药情况</h2>';
                content += '<div class="medication-toggle">';
                content += '<button id="show-current" class="toggle-btn active">当前用药情况</button>';
                content += '<button id="show-historical" class="toggle-btn">历史用药情况</button>';
                content += '</div>';
                
                // 创建两个部分，初始只显示当前用药情况
                content += '<div class="medication-sections">';
                content += '<div id="current-medications-section" class="medication-section"><h3>当前用药情况</h3><div id="current-medications-content" class="content-card">加载中...</div></div>';
                content += '<div id="historical-medications-section" class="medication-section" style="display: none;"><h3>历史用药情况</h3><div id="historical-medications-content" class="content-card">加载中...</div></div>';
                content += '</div>';
                content += '</div>';
                
                $('#content-area').html(content);
                
                // 添加切换按钮的事件处理
                $('#show-current').click(function() {
                    $('#show-current').addClass('active');
                    $('#show-historical').removeClass('active');
                    $('#current-medications-section').show();
                    $('#historical-medications-section').hide();
                });
                
                $('#show-historical').click(function() {
                    $('#show-historical').addClass('active');
                    $('#show-current').removeClass('active');
                    $('#historical-medications-section').show();
                    $('#current-medications-section').hide();
                });
                
                // 加载当前用药情况
                $.get('/api/current_medications', function(data) {
                    let currentContent = '';
                    
                    // 如果没有任何用药记录，显示提示信息
                    if (data.length === 0) {
                        currentContent += '<div class="empty-state"><p>当前没有任何家庭成员的用药记录</p></div>';
                    } else {
                        // 遍历每个家庭成员的用药情况
                        data.forEach(function(member) {
                            currentContent += `<h4>${member.member_name}的用药情况</h4>`;
                            if (member.medications.length === 0) {
                                currentContent += '<div class="empty-state"><p>当前没有用药记录</p></div>';
                            } else {
                                currentContent += '<table class="content-table">';
                                currentContent += '<tr><th>药品名称</th><th>剂量</th><th>开始时间</th><th>持续时间</th></tr>';
                                member.medications.forEach(function(med) {
                                    currentContent += `<tr>
                                        <td>${med.medicine_name}</td>
                                        <td>${med.dosage}</td>
                                        <td>${med.start_time}</td>
                                        <td>${med.lasting_time}</td>
                                    </tr>`;
                                });
                                currentContent += '</table>';
                            }
                        });
                    }
                    
                    $('#current-medications-content').html(currentContent);
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    // 添加错误处理
                    console.error("获取当前用药情况失败:", errorThrown);
                    $('#current-medications-content').html('<div class="empty-state"><p>加载当前用药数据失败，请稍后重试。</p></div>');
                });
                
                // 加载历史用药情况
                $.get('/api/historical_medications', function(data) {
                    let historyContent = '';
                    
                    // 如果没有任何历史用药记录，显示提示信息
                    if (data.length === 0) {
                        historyContent += '<div class="empty-state"><p>暂无历史用药记录</p></div>';
                    } else {
                        // 遍历每个家庭成员的历史用药情况
                        data.forEach(function(member) {
                            historyContent += `<h4>${member.member_name}的历史用药记录</h4>`;
                            if (member.medications.length === 0) {
                                historyContent += '<div class="empty-state"><p>无历史用药记录</p></div>';
                            } else {
                                historyContent += '<table class="content-table">';
                                historyContent += '<tr><th>药品名称</th><th>剂量</th><th>开始时间</th><th>结束时间</th><th>持续时间</th></tr>';
                                member.medications.forEach(function(med) {
                                    historyContent += `<tr>
                                        <td>${med.medicine_name}</td>
                                        <td>${med.dosage}</td>
                                        <td>${med.start_time}</td>
                                        <td>${med.end_time}</td>
                                        <td>${med.lasting_time}</td>
                                    </tr>`;
                                });
                                historyContent += '</table>';
                            }
                        });
                    }
                    
                    $('#historical-medications-content').html(historyContent);
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    // 添加错误处理
                    console.error("获取历史用药情况失败:", errorThrown);
                    $('#historical-medications-content').html('<div class="empty-state"><p>加载历史用药数据失败，请稍后重试。</p></div>');
                });
            });            $('#add-new-medicine').click(function() {
                let content = `
                    <div class="form-container">
                        <h2>添加新药</h2>
                        <div id="message-area"></div>
                        <form id="add-medicine-form">
                            <div class="form-group">
                                <label for="national_code">药品编码:</label>
                                <input type="text" id="national_code" name="national_code" required>
                            </div>
                            <div class="form-group">
                                <label for="name">药品名称:</label>
                                <input type="text" id="name" name="name" required>
                            </div>                            <div class="form-group">
                                <label>药品类型:</label>
                                <div class="radio-group">
                                    <div class="radio-option">
                                        <input type="radio" id="otc" name="medicine_type" value="OTC" required>
                                        <label for="otc">OTC</label>
                                    </div>
                                    <div class="radio-option">
                                        <input type="radio" id="prescription" name="medicine_type" value="Prescription" required>
                                        <label for="prescription">处方药</label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="manufacture_name">生产厂家:</label>
                                <input type="text" id="manufacture_name" name="manufacture_name" list="manufacture-list">
                                <datalist id="manufacture-list"></datalist>
                                <small class="helper-text">选择已有厂家或输入新厂家名称</small>
                            </div>
                            <div class="form-group" id="manufacture-address-group" style="display: none;">
                                <label for="manufacture_address">厂家地址:</label>
                                <input type="text" id="manufacture_address" name="manufacture_address">
                                <small class="helper-text">新厂家需要填写地址</small>
                            </div>
                            <div class="form-group" id="prescription-id-group" style="display: none;">
                                <label for="prescription_id">处方ID:</label>
                                <input type="text" id="prescription_id" name="prescription_id" list="prescription-list">
                                <datalist id="prescription-list"></datalist>
                                <small class="helper-text">处方药必须填写处方ID</small>
                            </div>                            <div class="form-group" id="otc-direction-group" style="display: none;">
                                <label for="direction">用法用量:</label>
                                <textarea id="direction" name="direction" rows="3"></textarea>
                                <small class="helper-text">OTC药品的用法说明</small>
                            </div>
                            <div class="form-group">
                                <label for="manufacture_date">生产日期:</label>
                                <input type="date" id="manufacture_date" name="manufacture_date">
                            </div>
                            <div class="form-group">
                                <label for="expiry_date">过期日期:</label>
                                <input type="date" id="expiry_date" name="expiry_date">
                            </div>
                            <div class="form-group">
                                <label for="remaining_quantity">剩余数量:</label>
                                <input type="number" id="remaining_quantity" name="remaining_quantity" min="0">
                            </div>
                            <div class="form-group">
                                <label for="price">价格:</label>
                                <input type="number" id="price" name="price" step="0.01" min="0">
                            </div>                            <div class="form-group">
                                <label for="cabinet_id">存放药箱:</label>
                                <select id="cabinet_id" name="cabinet_id"></select>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">添加药品</button>
                            </div>
                        </form>
                    </div>`;
                $('#content-area').html(content);

                // 获取药箱列表并填充下拉框
                $.get('/api/cabinets', function(cabinets) {
                    const cabinetSelect = $('#cabinet_id');
                    cabinets.forEach(function(cabinet) {
                        cabinetSelect.append(`<option value="${cabinet.cabinet_id}">${cabinet.location}</option>`);
                    });
                });

                // 获取生产厂家列表并填充datalist
                $.get('/api/manufactures', function(manufactures) {
                    const manufactureList = $('#manufacture-list');
                    manufactures.forEach(function(manufacture) {
                        manufactureList.append(`<option value="${manufacture.manufacture_name}">${manufacture.manufacture_name} - ${manufacture.address}</option>`);
                    });
                });

                // 获取处方列表并填充datalist
                $.get('/api/prescriptions', function(prescriptions) {
                    const prescriptionList = $('#prescription-list');
                    prescriptions.forEach(function(prescription) {
                        prescriptionList.append(`<option value="${prescription.prescription_id}">处方${prescription.prescription_id} - ${prescription.doctor}</option>`);
                    });
                });

                // 监听药品类型变化
                $('input[name="medicine_type"]').change(function() {
                    const medicineType = $(this).val();
                    if (medicineType === 'OTC') {
                        $('#prescription-id-group').hide();
                        $('#prescription_id').removeAttr('required');
                        $('#otc-direction-group').show();
                    } else if (medicineType === 'Prescription') {
                        $('#otc-direction-group').hide();
                        $('#prescription-id-group').show();
                        $('#prescription_id').attr('required', 'required');
                    }
                });

                // 监听生产厂家输入变化
                $('#manufacture_name').on('input', function() {
                    const manufactureName = $(this).val().trim();
                    if (manufactureName) {
                        // 检查厂家是否存在
                        $.get(`/api/check_manufacture/${encodeURIComponent(manufactureName)}`, function(result) {
                            if (result.exists) {
                                $('#manufacture-address-group').hide();
                                $('#manufacture_address').removeAttr('required');
                            } else {
                                $('#manufacture-address-group').show();
                                $('#manufacture_address').attr('required', 'required');
                            }
                        }).fail(function() {
                            // 如果请求失败，显示地址输入框
                            $('#manufacture-address-group').show();
                            $('#manufacture_address').attr('required', 'required');
                        });
                    } else {
                        $('#manufacture-address-group').hide();
                        $('#manufacture_address').removeAttr('required');
                    }
                });                $('#add-medicine-form').submit(function(event) {
                    event.preventDefault();
                    const formData = {
                        national_code: $('#national_code').val(),
                        name: $('#name').val(),
                        medicine_type: $('input[name="medicine_type"]:checked').val(), // 获取选中的药品类型
                        manufacture_name: $('#manufacture_name').val(),
                        manufacture_date: $('#manufacture_date').val(),
                        expiry_date: $('#expiry_date').val(),
                        remaining_quantity: parseInt($('#remaining_quantity').val()),
                        price: parseFloat($('#price').val()),
                        cabinet_id: parseInt($('#cabinet_id').val())
                    };

                    // 添加生产厂家地址（如果需要）
                    const manufactureAddress = $('#manufacture_address').val();
                    if (manufactureAddress) {
                        formData.manufacture_address = manufactureAddress;
                    }

                    // 添加处方ID（如果是处方药）
                    const prescriptionId = $('#prescription_id').val();
                    if (prescriptionId) {
                        formData.prescription_id = prescriptionId;
                    }

                    // 添加OTC用法说明（如果是OTC）
                    const direction = $('#direction').val();
                    if (direction) {
                        formData.direction = direction;
                    }

                    $.ajax({
                        url: '/api/add_medicine',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(formData),
                        success: function(response) {
                            $('#message-area').html(`<div class="success-message">${response.message}</div>`);
                            $('#add-medicine-form')[0].reset(); // 清空表单
                        },
                        error: function(xhr) {
                            const error = xhr.responseJSON ? xhr.responseJSON.error : '添加失败，请重试';
                            $('#message-area').html(`<div class="error-message">${error}</div>`);
                        }
                    });
                });
            });

            $('#refill-medicine').click(function() {
                $('.menu-item').removeClass('active');
                $(this).addClass('active');
                
                let content = '<div class="content-card"><h2>补充药品</h2>';
                content += '<div class="form-container">';
                content += '<div class="medicine-search">';
                content += '<input type="text" id="search-refill-medicine" placeholder="搜索药品名称或编码..." class="form-control">';
                content += '</div>';
                content += '<div id="refill-medicine-list">';
                content += '<p>加载中...</p>';
                content += '</div>';
                content += '</div>';
                content += '</div>';
                
                $('#content-area').html(content);
                
                // 加载药品列表用于补充
                loadMedicinesForRefill();
                
                // 绑定搜索功能
                $('#search-refill-medicine').on('input', function() {
                    filterRefillMedicines($(this).val());
                });
            });            $('#remove-medicine').click(function() {
                $('.menu-item').removeClass('active');
                $(this).addClass('active');
                
                let content = '<div class="content-card"><h2>删除药品</h2>';
                content += '<div class="warning-message">';
                content += '<strong>注意：</strong>此操作将减少药品数量，当数量减至0时将完全删除该药品记录。请谨慎操作！';
                content += '</div>';
                content += '<div class="form-container">';
                content += '<div class="medicine-search">';
                content += '<input type="text" id="search-delete-medicine" placeholder="搜索药品名称或编码..." class="form-control">';
                content += '</div>';
                content += '<div id="delete-medicine-list">';
                content += '<p>加载中...</p>';
                content += '</div>';
                content += '</div>';
                content += '</div>';
                
                $('#content-area').html(content);
                
                // 加载药品列表用于删除
                loadMedicinesForRemoval();
                
                // 绑定搜索功能
                $('#search-delete-medicine').on('input', function() {
                    filterDeleteMedicines($(this).val());
                });
            });
        });

        function viewMemberDetails(securityId) {
            $.get(`/api/member_details/${securityId}`, function(data) {
                let content = '<div class="content-card">';
                content += `<h2>${data.name}的详细信息</h2>`;
                content += '<div class="details-container">';
                content += `
                    <div class="detail-item"><div class="detail-label">身份证号</div><div class="detail-value">${data.security_id}</div></div>
                    <div class="detail-item"><div class="detail-label">性别</div><div class="detail-value">${data.gender}</div></div>
                    <div class="detail-item"><div class="detail-label">年龄</div><div class="detail-value">${data.age}</div></div>
                    <div class="detail-item"><div class="detail-label">体重</div><div class="detail-value">${data.weight} kg</div></div>
                    <div class="detail-item"><div class="detail-label">身高</div><div class="detail-value">${data.height} cm</div></div>
                    <div class="detail-item"><div class="detail-label">基础疾病</div><div class="detail-value">${data.underlying_disease || '无'}</div></div>
                    <div class="detail-item"><div class="detail-label">过敏原</div><div class="detail-value">${data.allergen || '无'}</div></div>
                `;
                content += '</div>';
                content += '<div style="margin-top: 20px;"><button onclick="returnToMembers()">返回</button></div>';
                content += '</div>';
                $('#content-area').html(content);
            });
        }

        function viewMedicineDetails(nationalCode) {
            $.get(`/api/medicine_details/${nationalCode}`, function(data) {
                let content = `
            <div class="content-card">
                <h2>药品详情: ${data.name}</h2>
                <p><strong>药品编码:</strong> ${data.national_code}</p>
                <p><strong>药品类型:</strong> ${data.medicine_type}</p> <!-- 显示药品类型 -->
                <p><strong>生产厂家:</strong> ${data.manufacture_name || '未提供'}</p>
                <p><strong>生产日期:</strong> ${data.manufacture_date}</p>
                <p><strong>过期日期:</strong> ${data.expiry_date}</p>
                <p><strong>剩余数量:</strong> ${data.remaining_quantity}</p>
                <p><strong>价格:</strong> ${data.price !== null ? data.price.toFixed(2) : '未提供'}</p>
                <p><strong>存放药箱:</strong> ${data.cabinet_location}</p>
                <button onclick="$('#query-medicines').click()" class="btn btn-secondary">返回药品列表</button>
            </div>
        `;
                $('#content-area').html(content);
            }).fail(function() {
                $('#content-area').html('<p class="error-message">无法加载药品详情。</p>');
            });
        }

        function viewPrescriptionDetails(prescriptionId) {
            $.get(`/api/prescription_details/${prescriptionId}`, function(data) {
                let content = '<div class="content-card">';
                content += `<h2>处方详细信息</h2>`;
                content += '<div class="details-container">';
                content += `
                    <div class="detail-item"><div class="detail-label">处方ID</div><div class="detail-value">${data.prescription_id}</div></div>
                    <div class="detail-item"><div class="detail-label">开具时间</div><div class="detail-value">${data.time}</div></div>
                    <div class="detail-item"><div class="detail-label">开具医生</div><div class="detail-value">${data.doctor}</div></div>
                `;
                content += '</div>';

                content += '<h3>处方用户</h3>';
                content += '<div class="content-card" style="margin-bottom: 20px;">';
                content += '<table class="content-table">';
                content += '<tr><th>用户ID</th><th>姓名</th></tr>';
                data.members.forEach(function(member) {
                    content += `<tr><td>${member.security_id}</td><td>${member.name}</td></tr>`;
                });
                content += '</table>';
                content += '</div>';

                content += '<h3>处方药品</h3>';
                content += '<div class="content-card">';
                content += '<table class="content-table">';
                content += '<tr><th>药品编码</th><th>药品名称</th></tr>';
                data.medicines.forEach(function(medicine) {
                    content += `<tr><td>${medicine.national_code}</td><td>${medicine.name}</td></tr>`;
                });
                content += '</table>';
                content += '</div>';
                
                content += '<div style="margin-top: 20px;"><button onclick="returnToPrescriptions()">返回</button></div>';
                content += '</div>';
                $('#content-area').html(content);
            });
        }
        
        // 添加返回函数
        function returnToMembers() {
            $('#query-members').click();
        }
        
        function returnToMedicines() {
            $('#query-medicines').click();
        }
        
        function returnToPrescriptions() {
            $('#query-prescriptions').click();
        }
        
        // 加载药箱位置选项
        function loadCabinetOptions() {
            $.get('/api/cabinets', function(data) {
                let options = '<option value="">请选择存放位置</option>';
                data.forEach(function(cabinet) {
                    options += `<option value="${cabinet.cabinet_id}">${cabinet.location}</option>`;
                });
                $('#cabinet_id').html(options);
            }).fail(function() {
                console.warn("无法加载药箱位置信息");
            });
        }
        
        // 加载生产商选项
        function loadManufactureOptions() {
            $.get('/api/manufactures', function(data) {
                // 保存生产商数据到全局变量，用于后续检查
                window.manufactures = data;
                
                // 清空现有选项
                $('#manufacture-list').empty();
                
                // 添加选项到datalist
                data.forEach(function(manufacture) {
                    $('#manufacture-list').append(`<option value="${manufacture.manufacture_name}">${manufacture.manufacture_name}</option>`);
                });
            }).fail(function() {
                console.warn("无法加载生产商信息");
            });
        }
        
        // 检查生产商名称是否存在
        function checkManufactureName() {
            const manufactureName = $('#manufacture_name').val().trim();
            
            if (!manufactureName) {
                $('.manufacture-address-group').hide();
                return;
            }
            
            // 检查名称是否在已有生产商列表中
            const isExisting = window.manufactures && window.manufactures.some(m => m.manufacture_name === manufactureName);
            
            if (isExisting) {
                // 如果存在，隐藏地址字段
                $('.manufacture-address-group').hide();
                $('#manufacture_address').val(''); // 清空地址
            } else {
                // 如果不存在，显示地址字段
                $('.manufacture-address-group').show();
            }
        }
        
        // 显示消息
        function showMessage(message, type) {
            $('.success-message, .error-message').remove();
            const messageClass = type === 'success' ? 'success-message' : 'error-message';
            const messageHtml = `<div class="${messageClass}">${message}</div>`;
            $('.form-container').prepend(messageHtml);
        }
        
        // 提交药品表单
        function submitMedicineForm() {
            const formData = {
                national_code: $('#national_code').val(),
                name: $('#name').val(),
                manufacture_name: $('#manufacture_name').val() || null,
                manufacture_date: $('#manufacture_date').val() || null,
                expiry_date: $('#expiry_date').val() || null,
                remaining_quantity: parseInt($('#remaining_quantity').val()) || 0,
                price: parseFloat($('#price').val()) || 0.0,
                cabinet_id: parseInt($('#cabinet_id').val()) || null
            };
            
            // 验证必填字段
            if (!formData.national_code || !formData.name) {
                showMessage('请填写所有必填字段！', 'error');
                return;
            }
              $.ajax({
                url: '/api/add_medicine',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    if (response.updated) {
                        showMessage(response.message, 'success');
                    } else {
                        showMessage('药品添加成功！', 'success');
                    }
                    resetForm();
                },
                error: function(xhr, status, error) {
                    let errorMsg = '添加药品失败！';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    }
                    showMessage(errorMsg, 'error');
                }
            });
        }
        
        // 提交新药品表单
        function submitNewMedicineForm() {
            const manufactureName = $('#manufacture_name').val().trim();
            const isExistingManufacture = window.manufactures && window.manufactures.some(m => m.manufacture_name === manufactureName);
            
            const formData = {
                national_code: $('#national_code').val(),
                name: $('#name').val(),
                manufacture_name: manufactureName || null,
                manufacture_date: $('#manufacture_date').val() || null,
                expiry_date: $('#expiry_date').val() || null,
                remaining_quantity: parseInt($('#remaining_quantity').val()) || 0,
                price: parseFloat($('#price').val()) || 0.0,
                cabinet_id: parseInt($('#cabinet_id').val()) || null,
                is_new: true  // 标记为新药品
            };
            
            // 如果是新的生产商，添加地址信息
            if (manufactureName && !isExistingManufacture) {
                formData.manufacture_address = $('#manufacture_address').val().trim();
                
                // 验证新生产商必须提供地址
                if (!formData.manufacture_address) {
                    showMessage('新的生产厂家必须提供地址信息', 'error');
                    return;
                }
            }
            
            // 验证必填字段
            if (!formData.national_code || !formData.name) {
                showMessage('请填写所有必填字段！', 'error');
                return;
            }
            
            $.ajax({
                url: '/api/add_new_medicine',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    showMessage(response.message, 'success');
                    resetNewMedicineForm();
                    // 如果添加了新的生产商，重新加载生产商列表
                    if (manufactureName && !isExistingManufacture) {
                        loadManufactureOptions();
                    }
                },
                error: function(xhr, status, error) {
                    let errorMsg = '添加新药品失败！';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    }
                    showMessage(errorMsg, 'error');
                }
            });
        }
        
        // 重置新药品表单
        function resetNewMedicineForm() {
            $('#add-new-medicine-form')[0].reset();
            $('.success-message, .error-message').remove();
        }
        
        // 加载药品列表用于补充
        function loadMedicinesForRefill() {
            $.get('/api/medicines', function(data) {
                displayMedicinesForRefill(data);
                window.allRefillMedicines = data; // 保存所有药品数据用于搜索
            }).fail(function() {
                $('#refill-medicine-list').html('<p class="error-message">加载药品列表失败！</p>');
            });
        }
        
        // 显示药品列表用于补充
        function displayMedicinesForRefill(medicines) {
            if (medicines.length === 0) {
                $('#refill-medicine-list').html('<p>暂无药品可补充</p>');
                return;
            }
            
            let html = '';
            medicines.forEach(function(medicine) {
                html += `
                    <div class="medicine-item" data-code="${medicine.national_code}">
                        <div class="medicine-info">
                            <strong>${medicine.name}</strong><br>
                            <small>编码: ${medicine.national_code} | 当前数量: ${medicine.remaining_quantity}</small>
                        </div>
                        <div class="medicine-actions">
                            <label>补充数量:</label>
                            <input type="number" class="quantity-input" min="1" value="1" id="refill-qty-${medicine.national_code}">
                            <button class="btn btn-primary" onclick="refillMedicine('${medicine.national_code}', '${medicine.name}')">补充</button>
                        </div>
                    </div>
                `;
            });
            $('#refill-medicine-list').html(html);
        }
        
        // 过滤药品列表用于补充
        function filterRefillMedicines(searchTerm) {
            if (!window.allRefillMedicines) return;
            
            const filtered = window.allRefillMedicines.filter(medicine => 
                medicine.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                medicine.national_code.toLowerCase().includes(searchTerm.toLowerCase())
            );
            displayMedicinesForRefill(filtered);
        }
        
        // 补充药品
        function refillMedicine(nationalCode, medicineName) {
            const quantityToAdd = parseInt($(`#refill-qty-${nationalCode}`).val());
            
            if (!quantityToAdd || quantityToAdd <= 0) {
                alert('请输入有效的补充数量！');
                return;
            }
            
            const formData = {
                national_code: nationalCode,
                quantity_to_add: quantityToAdd
            };
            
            $.ajax({
                url: '/api/refill_medicine',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    showMessage(response.message, 'success');
                    // 重新加载药品列表
                    loadMedicinesForRefill();
                },
                error: function(xhr, status, error) {
                    let errorMsg = '补充药品失败！';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    }
                    showMessage(errorMsg, 'error');
                }
            });
        }
        
        // 用于删除药品的搜索过滤
        function filterDeleteMedicines(searchTerm) {
            if (!window.allMedicines) return;
            
            const filtered = window.allMedicines.filter(medicine => 
                medicine.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                medicine.national_code.toLowerCase().includes(searchTerm.toLowerCase())
            );
            displayMedicinesForRemoval(filtered);
        }
        
        // 加载药品列表用于删除
        function loadMedicinesForRemoval() {
            $.get('/api/medicines', function(data) {
                displayMedicinesForRemoval(data);
                window.allMedicines = data; // 保存所有药品数据用于搜索
            }).fail(function() {
                $('#delete-medicine-list').html('<p class="error-message">加载药品列表失败！</p>');
            });
        }
        
        // 显示药品列表用于删除
        function displayMedicinesForRemoval(medicines) {
            if (medicines.length === 0) {
                $('#delete-medicine-list').html('<p>暂无药品可删除</p>');
                return;
            }
            
            let html = '';
            medicines.forEach(function(medicine) {
                html += `
                    <div class="medicine-item" data-code="${medicine.national_code}">
                        <div class="medicine-info">
                            <strong>${medicine.name}</strong><br>
                            <small>编码: ${medicine.national_code} | 剩余数量: ${medicine.remaining_quantity}</small>
                        </div>
                        <div class="medicine-actions">
                            <label>删除数量:</label>
                            <input type="number" class="quantity-input" min="1" max="${medicine.remaining_quantity}" value="1" id="qty-${medicine.national_code}">
                            <button class="btn btn-danger" onclick="removeMedicine('${medicine.national_code}', '${medicine.name}', ${medicine.remaining_quantity})">删除</button>
                        </div>
                    </div>
                `;
            });
            $('#delete-medicine-list').html(html);
        }
        
        // 重置表单
        function resetForm() {
            $('#add-medicine-form')[0].reset();
            $('.success-message, .error-message').remove();
        }
        
        // 删除药品
        function removeMedicine(nationalCode, medicineName, currentQuantity) {
            const quantityToRemove = parseInt($(`#qty-${nationalCode}`).val());
            
            if (!quantityToRemove || quantityToRemove <= 0) {
                alert('请输入有效的删除数量！');
                return;
            }
            
            if (quantityToRemove > currentQuantity) {
                alert('删除数量不能超过当前剩余数量！');
                return;
            }
            
            const willBeDeleted = quantityToRemove >= currentQuantity;
            
            if (willBeDeleted) {
                // 如果要完全删除，先检查使用状态
                $.get(`/api/medicine_usage/${nationalCode}`, function(usageData) {
                    if (!usageData.can_be_deleted) {
                        let activeUsersList = usageData.active_users.map(user => `${user.name} (${user.dosage})`).join(', ');
                        alert(`无法完全删除该药品！\n正在使用该药品的用户：${activeUsersList}\n请先停止相关用药记录。`);
                        return;
                    }
                    
                    let confirmMessage = `确定要完全删除药品"${medicineName}"吗？\n`;
                    if (usageData.historical_usage_count > 0) {
                        confirmMessage += `注意：该药品有 ${usageData.historical_usage_count} 条历史用药记录，删除后这些记录仍会保留。\n`;
                    }
                    confirmMessage += '此操作不可恢复！';
                    
                    if (confirm(confirmMessage)) {
                        performRemoveOperation(nationalCode, quantityToRemove);
                    }
                }).fail(function() {
                    alert('检查药品使用状态失败，请稍后重试！');
                });
            } else {
                const confirmMessage = `确定要从"${medicineName}"中删除 ${quantityToRemove} 个吗？`;
                if (confirm(confirmMessage)) {
                    performRemoveOperation(nationalCode, quantityToRemove);
                }
            }
        }
        
        // 执行删除操作
        function performRemoveOperation(nationalCode, quantityToRemove) {
            $.ajax({
                url: '/api/remove_medicine',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    national_code: nationalCode,
                    quantity_to_remove: quantityToRemove
                }),
                success: function(response) {
                    showMessage(response.message, 'success');
                    // 重新加载药品列表
                    loadMedicinesForRemoval();
                },
                error: function(xhr, status, error) {
                    let errorMsg = '删除药品失败！';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    }                    showMessage(errorMsg, 'error');
                }
            });
        }
          // 添加药品提醒功能
        $('#medicine-alerts').click(function() {
            $('#content-area').html('<div class="content-card"><h2>药品提醒</h2><p>加载中，请稍候...</p></div>');
            
            // 创建页面布局
            let content = '<div class="content-card"><h2>药品提醒</h2>';
            content += '<div class="alerts-container">';
            
            // 第一栏 - 即将过期提醒
            content += '<div class="alert-section expiry-alerts">';
            content += '<h3>即将过期药品（30天内）</h3>';
            content += '<div id="expiring-medicines" class="alerts-content">加载中...</div>';
            content += '</div>';
            
            // 第二栏 - 已过期提醒
            content += '<div class="alert-section expired-alerts">';
            content += '<h3>已过期药品</h3>';
            content += '<div id="expired-medicines" class="alerts-content">加载中...</div>';
            content += '</div>';
            
            // 第三栏 - 库存提醒
            content += '<div class="alert-section stock-alerts">';
            content += '<h3>库存不足药品（少于3个）</h3>';
            content += '<div id="low-stock-medicines" class="alerts-content">加载中...</div>';
            content += '</div>';
            
            content += '</div></div>';
            
            $('#content-area').html(content);
            
            // 加载即将过期的药品
            $.get('/api/expiring_medicines', function(data) {
                let expiryContent = '';
                
                if (data.length === 0) {
                    expiryContent = '<div class="empty-alert"><p>没有即将过期的药品</p></div>';
                } else {
                    expiryContent = '<div class="alert-items">';
                    data.forEach(function(medicine) {
                        let urgencyClass = '';
                        if (medicine.days_until_expiry <= 7) {
                            urgencyClass = 'urgent-alert'; // 7天内过期
                        } else if (medicine.days_until_expiry <= 15) {
                            urgencyClass = 'warning-alert'; // 15天内过期
                        }
                        
                        expiryContent += `
                            <div class="alert-item ${urgencyClass}">
                                <div class="alert-header">
                                    <h4>${medicine.name}</h4>
                                    <span class="expiry-days">${medicine.days_until_expiry}天后过期</span>
                                </div>
                                <div class="alert-details">
                                    <p><strong>编码:</strong> ${medicine.national_code}</p>
                                    <p><strong>过期日期:</strong> ${medicine.expiry_date}</p>
                                    <p><strong>剩余数量:</strong> ${medicine.remaining_quantity}</p>
                                    <p><strong>存放位置:</strong> ${medicine.cabinet_location}</p>
                                </div>
                                <div class="alert-actions">
                                    <button onclick="viewMedicineDetails('${medicine.national_code}')" class="btn btn-primary">查看详情</button>
                                </div>
                            </div>
                        `;
                    });
                    expiryContent += '</div>';
                }
                
                $('#expiring-medicines').html(expiryContent);
            }).fail(function() {
                $('#expiring-medicines').html('<div class="error-message">获取过期药品信息失败</div>');
            });
            
            // 加载库存不足的药品
            $.get('/api/low_stock_medicines', function(data) {
                let stockContent = '';
                
                if (data.length === 0) {
                    stockContent = '<div class="empty-alert"><p>没有库存不足的药品</p></div>';
                } else {
                    stockContent = '<div class="alert-items">';
                    data.forEach(function(medicine) {
                        let urgencyClass = '';
                        if (medicine.remaining_quantity === 1) {
                            urgencyClass = 'urgent-alert'; // 仅剩1个
                        } else {
                            urgencyClass = 'warning-alert'; // 2个
                        }
                        
                        stockContent += `
                            <div class="alert-item ${urgencyClass}">
                                <div class="alert-header">
                                    <h4>${medicine.name}</h4>
                                    <span class="stock-count">剩余: ${medicine.remaining_quantity}个</span>
                                </div>
                                <div class="alert-details">
                                    <p><strong>编码:</strong> ${medicine.national_code}</p>
                                    <p><strong>存放位置:</strong> ${medicine.cabinet_location}</p>
                                </div>                                <div class="alert-actions">
                                    <button onclick="viewMedicineDetails('${medicine.national_code}')" class="btn btn-primary">查看详情</button>
                                </div>
                            </div>
                        `;
                    });
                    stockContent += '</div>';
                }
                
                $('#low-stock-medicines').html(stockContent);
            }).fail(function() {
                $('#low-stock-medicines').html('<div class="error-message">获取库存药品信息失败</div>');
            });
            
            // 加载已过期的药品
            $.get('/api/expired_medicines', function(data) {
                let expiredContent = '';
                
                if (data.length === 0) {
                    expiredContent = '<div class="empty-alert"><p>没有已过期的药品</p></div>';
                } else {
                    expiredContent = '<div class="alert-items">';
                    data.forEach(function(medicine) {
                        let urgencyClass = '';
                        if (medicine.days_expired <= 30) {
                            urgencyClass = 'urgent-alert'; // 30天内过期
                        } else if (medicine.days_expired <= 90) {
                            urgencyClass = 'warning-alert'; // 90天内过期
                        } else {
                            urgencyClass = 'danger-alert'; // 90天以上过期
                        }
                        
                        expiredContent += `
                            <div class="alert-item ${urgencyClass}">
                                <div class="alert-header">
                                    <h4>${medicine.name}</h4>
                                    <span class="expired-days">已过期 ${medicine.days_expired}天</span>
                                </div>
                                <div class="alert-details">
                                    <p><strong>编码:</strong> ${medicine.national_code}</p>
                                    <p><strong>过期日期:</strong> ${medicine.expiry_date}</p>
                                    <p><strong>剩余数量:</strong> ${medicine.remaining_quantity}</p>
                                    <p><strong>存放位置:</strong> ${medicine.cabinet_location}</p>
                                </div>
                                <div class="alert-actions">
                                    <button onclick="viewMedicineDetails('${medicine.national_code}')" class="btn btn-primary">查看详情</button>
                                    <button onclick="showRemoveExpiredDialog('${medicine.national_code}', '${medicine.name}')" class="btn btn-danger">删除过期药品</button>
                                </div>
                            </div>
                        `;
                    });
                    expiredContent += '</div>';
                }
                
                $('#expired-medicines').html(expiredContent);
            }).fail(function() {
                $('#expired-medicines').html('<div class="error-message">获取已过期药品信息失败</div>');
            });
        });
        
        // 显示补充药品对话框
        function showRefillDialog(nationalCode, medicineName) {
            let dialogContent = `
                <div class="form-container">
                    <h3>补充药品: ${medicineName}</h3>
                    <div class="form-group">
                        <label for="refill-quantity">补充数量</label>
                        <input type="number" id="refill-quantity" min="1" value="1">
                    </div>
                    <button class="btn btn-primary" onclick="refillMedicine('${nationalCode}', '${medicineName}')">确认补充</button>
                    <button class="btn btn-secondary" onclick="loadMedicineAlerts()">取消</button>
                </div>
            `;
            
            $('#content-area').html(dialogContent);
        }
        
        // 补充药品操作
        function refillMedicine(nationalCode, medicineName) {
            const quantity = parseInt($('#refill-quantity').val());
            
            if (isNaN(quantity) || quantity <= 0) {
                showMessage('请输入有效的补充数量', 'error');
                return;
            }
            
            $.ajax({
                url: '/api/refill_medicine',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    national_code: nationalCode,
                    quantity_to_add: quantity
                }),
                success: function(response) {
                    showMessage(response.message, 'success');
                    // 重新加载药品提醒页面
                    $('#medicine-alerts').click();
                },
                error: function(xhr, status, error) {
                    let errorMsg = '补充药品失败！';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    }
                    showMessage(errorMsg, 'error');
                }
            });
        }
        
        // 重新加载药品提醒页面
        function loadMedicineAlerts() {
            $('#medicine-alerts').click();
        }
        
        // 显示删除过期药品对话框
        function showRemoveExpiredDialog(nationalCode, medicineName) {
            if (confirm(`确定要删除过期药品"${medicineName}"吗？\n注意：这将完全删除该药品的所有库存！\n此操作不可恢复！`)) {
                removeExpiredMedicine(nationalCode, medicineName);
            }
        }
        
        // 删除过期药品
        function removeExpiredMedicine(nationalCode, medicineName) {
            // 获取药品详情以确定删除数量
            $.get(`/api/medicine_details/${nationalCode}`, function(medicine) {
                $.ajax({
                    url: '/api/remove_medicine',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        national_code: nationalCode,
                        quantity_to_remove: medicine.remaining_quantity // 删除全部库存
                    }),
                    success: function(response) {
                        showMessage(`已删除过期药品"${medicineName}"！`, 'success');
                        // 重新加载药品提醒页面
                        $('#medicine-alerts').click();
                    },
                    error: function(xhr, status, error) {
                        let errorMsg = '删除过期药品失败！';
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        }
                        showMessage(errorMsg, 'error');
                    }
                });
            }).fail(function() {
                showMessage('获取药品信息失败，无法删除！', 'error');
            });
        }
        
        // 编辑成员信息
        function editMemberInfo(securityId) {
            // 首先获取成员的详细信息
            $.get(`/api/member_details_for_edit/${securityId}`, function(data) {
                let content = `
                    <div class="form-container">
                        <h2>编辑成员信息</h2>
                        <div id="edit-member-message-area"></div>
                        
                        ${data.total_related_records > 0 ? 
                            `<div class="warning-message">
                                <strong>注意：</strong>该成员有 ${data.total_related_records} 条相关记录（用药记录: ${data.has_medicine_records ? '有' : '无'}，处方记录: ${data.has_prescription_records ? '有' : '无'}）。
                                修改身份证号将同时更新所有相关记录。
                            </div>` : ''
                        }
                        
                        <form id="edit-member-form">
                            <div class="form-group">
                                <label for="old_security_id">当前身份证号:</label>
                                <input type="text" id="old_security_id" name="old_security_id" value="${data.security_id}" readonly style="background-color: #f5f5f5;">
                            </div>
                            <div class="form-group">
                                <label for="new_security_id">新身份证号:</label>
                                <input type="text" id="new_security_id" name="new_security_id" value="${data.security_id}" required>
                                <small class="helper-text">可以修改为新的身份证号，或保持不变</small>
                            </div>
                            <div class="form-group">
                                <label for="edit_name">姓名:</label>
                                <input type="text" id="edit_name" name="name" value="${data.name}" required>
                            </div>
                            <div class="form-group">
                                <label for="edit_gender">性别:</label>
                                <select id="edit_gender" name="gender" required>
                                    <option value="M" ${data.gender === 'M' ? 'selected' : ''}>男</option>
                                    <option value="F" ${data.gender === 'F' ? 'selected' : ''}>女</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="edit_age">年龄:</label>
                                <input type="number" id="edit_age" name="age" value="${data.age}" min="1" max="150" required>
                            </div>
                            <div class="form-group">
                                <label for="edit_weight">体重 (kg):</label>
                                <input type="number" id="edit_weight" name="weight" value="${data.weight}" step="0.1" min="1" required>
                            </div>
                            <div class="form-group">
                                <label for="edit_height">身高 (cm):</label>
                                <input type="number" id="edit_height" name="height" value="${data.height}" step="0.1" min="1" required>
                            </div>
                            <div class="form-group">
                                <label for="edit_underlying_disease">基础疾病:</label>
                                <textarea id="edit_underlying_disease" name="underlying_disease" rows="3">${data.underlying_disease}</textarea>
                                <small class="helper-text">如有多种疾病，请用逗号分隔</small>
                            </div>
                            <div class="form-group">
                                <label for="edit_allergen">过敏原:</label>
                                <textarea id="edit_allergen" name="allergen" rows="3">${data.allergen}</textarea>
                                <small class="helper-text">如有多种过敏原，请用逗号分隔</small>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">保存修改</button>
                                <button type="button" class="btn btn-secondary" onclick="$('#query-members').click()">取消</button>
                            </div>
                        </form>
                    </div>`;
                
                $('#content-area').html(content);
                
                // 绑定表单提交事件
                $('#edit-member-form').submit(function(event) {
                    event.preventDefault();
                    updateMemberInfo();
                });
                
            }).fail(function(xhr) {
                let errorMsg = '获取成员信息失败！';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                }
                alert(errorMsg);
            });
        }
        
        // 更新成员信息
        function updateMemberInfo() {
            const formData = {
                old_security_id: $('#old_security_id').val(),
                new_security_id: $('#new_security_id').val().trim(),
                name: $('#edit_name').val().trim(),
                gender: $('#edit_gender').val(),
                age: parseInt($('#edit_age').val()),
                weight: parseFloat($('#edit_weight').val()),
                height: parseFloat($('#edit_height').val()),
                underlying_disease: $('#edit_underlying_disease').val().trim(),
                allergen: $('#edit_allergen').val().trim()
            };
              // 验证必填字段
            if (!formData.new_security_id || !formData.name || !formData.gender || 
                !formData.age || !formData.weight || !formData.height) {
                showEditMemberMessage('请填写所有必填字段！', 'error');
                return;
            }
            
            $.ajax({
                url: '/api/update_member',
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    showEditMemberMessage(response.message, 'success');
                    // 延迟返回列表，让用户看到成功消息
                    setTimeout(function() {
                        $('#query-members').click();
                    }, 2000);
                },
                error: function(xhr, status, error) {
                    let errorMsg = '更新成员信息失败！';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    }
                    showEditMemberMessage(errorMsg, 'error');
                }
            });
        }
        
        // 显示编辑成员信息的消息
        function showEditMemberMessage(message, type) {
            $('#edit-member-message-area').html('');
            const messageClass = type === 'success' ? 'success-message' : 'error-message';
            const messageHtml = `<div class="${messageClass}">${message}</div>`;
            $('#edit-member-message-area').html(messageHtml);
            
            // 滚动到消息区域
            $('html, body').animate({
                scrollTop: $('#edit-member-message-area').offset().top - 100
            }, 300);
        }
    </script>
</body>
</html>